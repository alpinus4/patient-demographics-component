<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="patient-demographics.html">
<link rel="import" href="https://polygit.org/polymer+v2.0.0/shadycss+webcomponents+1.0.0/components/iron-ajax/iron-ajax.html">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link rel="import" href="/bower_components/polymer/polymer.html">



<dom-module id="patient-search">
  <template>

    <patient-demographics first-name="{{patient.0.person.preferredName.givenName}}"
                          middle-name="{{patient.0.person.preferredName.middleName}}"
                          last-name="{{patient.0.person.preferredName.familyName}}"
                          age="{{patient.0.person.age}}"
                          date-of-birth="{{patient.0.person.birthdate}}"
                          gender="{{patient.0.person.gender}}"
                          patientid="{{patient.0.identifiers.0.identifier}}"
                          address="{{patient.0.person.preferredAddress.address1}}"
                          city-village="{{patient.0.person.preferredAddress.cityVillage}}"
                          state-province="{{patient.0.person.preferredAddress.stateProvince}}"
                          country="{{patient.0.person.preferredAddress.country}}"
                          telephone-number="500-500-5643"
                          dead="{{patient.0.person.dead}}"></patient-demographics>

    <iron-ajax
    url="http://localhost:8080/lh-toolkit/ws/rest/v1/patient"
    params='{"q":"{{sq}}", "v":"full"}'
    content-type="application/json"
    handle-as="json"
    with-credentials="true"
    on-response="handleResponse"
    method="GET"
    on-error="_error"></iron-ajax>

  </template>

  <script>
    class PatientSearch extends Polymer.Element {
      static get is() {
        return 'patient-search';
      }
      static get properties() {
        return {
          patient: {
            type: Array,
            notify:true
          },
          sq:{
            type:String,
            observer: "_changedSQ"
          }
        }
      }
      constructor() {
        super();
      }
      handleResponse(data){
        this.patient = data.detail.response.results;
        console.log(this.patient); //Gives empty array (length 0)
      }


      _error(event){
        console.log(event);
        console.log(event.detail);
        console.log(event.detail.error);
        console.log(event.detail.error.message);
        console.log(event.detail.request);
        console.log(event.detail.response);
        console.log(event.detail.request.response);
      }

      _changedSQ(){
        Polymer.dom(this.root).querySelector('iron-ajax').generateRequest();
      }

    }
    customElements.define(PatientSearch.is, PatientSearch);
  </script>
</dom-module>
